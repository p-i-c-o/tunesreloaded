import{s as H,e as $,f as b,h as u,j as E,m as V,k as D,S as h,A as W,B as G,T as f,d as q}from"./main-tDLtfsZw.js";function M(n){let e=n.trim();if(e.length!==36||e[8]!=="-"||e[13]!=="-"||e[18]!=="-"||e[23]!=="-")throw new Error(`Invalid GUID format: ${n}`);let t;const r=new Uint8Array(16);t=parseInt(e.slice(0,8),16),r[0]=t&255,r[1]=t>>>8&255,r[2]=t>>>16&255,r[3]=t>>>24&255,t=parseInt(e.slice(9,13),16),r[4]=t&255,r[5]=t>>>8&255,t=parseInt(e.slice(14,18),16),r[6]=t&255,r[7]=t>>>8&255,t=parseInt(e.slice(19,23),16),r[8]=t>>>8&255,r[9]=t&255,t=parseInt(e.slice(24,32),16),r[10]=t>>>24&255,r[11]=t>>>16&255,r[12]=t>>>8&255,r[13]=t&255,t=parseInt(e.slice(32,36),16),r[14]=t>>>8&255,r[15]=t&255;for(let s=0;s<16;s++)if(!Number.isFinite(r[s]))throw new Error(`Invalid GUID format: ${n}`);if(!/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(e))throw new Error(`Invalid GUID format: ${n}`);return r}class S{constructor(e){if(e.length!==16)throw new Error("GUID must be exactly 16 bytes");this.bytes=e}static fromString(e){return new S(M(e))}toString(){const e=this.bytes,t=d=>d.toString(16).padStart(2,"0"),r=t(e[3])+t(e[2])+t(e[1])+t(e[0]),s=t(e[5])+t(e[4]),c=t(e[7])+t(e[6]),i=t(e[8])+t(e[9]),o=t(e[10])+t(e[11])+t(e[12])+t(e[13])+t(e[14])+t(e[15]);return`${r}-${s}-${c}-${i}-${o}`.toUpperCase()}equals(e,t=0){if(t<0||e.length-t<16)return!1;const r=this.bytes;for(let s=0;s<16;s++)if(e[t+s]!==r[s])return!1;return!0}}class a{static fromBin(e,t=0){return new a(a.decode(e,t))}static decode(e,t=0){return new S(e.subarray(t,t+16)).toString()}static decodeMediaType(e){switch(e.str){case a.AudioMedia.str:return"audio";case a.VideoMedia.str:return"video";case a.CommandMedia.str:return"command";case a.Degradable_JPEG_Media.str:return"degradable-jpeg";case a.FileTransferMedia.str:return"file-transfer";case a.BinaryMedia.str:return"binary"}}static encode(e){return M(e)}constructor(e){this.str=e}equals(e){return this.str===e.str}toBin(){return a.encode(this.str)}}a.HeaderObject=new a("75B22630-668E-11CF-A6D9-00AA0062CE6C");a.DataObject=new a("75B22636-668E-11CF-A6D9-00AA0062CE6C");a.SimpleIndexObject=new a("33000890-E5B1-11CF-89F4-00A0C90349CB");a.IndexObject=new a("D6E229D3-35DA-11D1-9034-00A0C90349BE");a.MediaObjectIndexObject=new a("FEB103F8-12AD-4C64-840F-2A1D2F7AD48C");a.TimecodeIndexObject=new a("3CB73FD0-0C4A-4803-953D-EDF7B6228F0C");a.FilePropertiesObject=new a("8CABDCA1-A947-11CF-8EE4-00C00C205365");a.StreamPropertiesObject=new a("B7DC0791-A9B7-11CF-8EE6-00C00C205365");a.HeaderExtensionObject=new a("5FBF03B5-A92E-11CF-8EE3-00C00C205365");a.CodecListObject=new a("86D15240-311D-11D0-A3A4-00A0C90348F6");a.ScriptCommandObject=new a("1EFB1A30-0B62-11D0-A39B-00A0C90348F6");a.MarkerObject=new a("F487CD01-A951-11CF-8EE6-00C00C205365");a.BitrateMutualExclusionObject=new a("D6E229DC-35DA-11D1-9034-00A0C90349BE");a.ErrorCorrectionObject=new a("75B22635-668E-11CF-A6D9-00AA0062CE6C");a.ContentDescriptionObject=new a("75B22633-668E-11CF-A6D9-00AA0062CE6C");a.ExtendedContentDescriptionObject=new a("D2D0A440-E307-11D2-97F0-00A0C95EA850");a.ContentBrandingObject=new a("2211B3FA-BD23-11D2-B4B7-00A0C955FC6E");a.StreamBitratePropertiesObject=new a("7BF875CE-468D-11D1-8D82-006097C9A2B2");a.ContentEncryptionObject=new a("2211B3FB-BD23-11D2-B4B7-00A0C955FC6E");a.ExtendedContentEncryptionObject=new a("298AE614-2622-4C17-B935-DAE07EE9289C");a.DigitalSignatureObject=new a("2211B3FC-BD23-11D2-B4B7-00A0C955FC6E");a.PaddingObject=new a("1806D474-CADF-4509-A4BA-9AABCB96AAE8");a.ExtendedStreamPropertiesObject=new a("14E6A5CB-C672-4332-8399-A96952065B5A");a.AdvancedMutualExclusionObject=new a("A08649CF-4775-4670-8A16-6E35357566CD");a.GroupMutualExclusionObject=new a("D1465A40-5A79-4338-B71B-E36B8FD6C249");a.StreamPrioritizationObject=new a("D4FED15B-88D3-454F-81F0-ED5C45999E24");a.BandwidthSharingObject=new a("A69609E6-517B-11D2-B6AF-00C04FD908E9");a.LanguageListObject=new a("7C4346A9-EFE0-4BFC-B229-393EDE415C85");a.MetadataObject=new a("C5F8CBEA-5BAF-4877-8467-AA8C44FA4CCA");a.MetadataLibraryObject=new a("44231C94-9498-49D1-A141-1D134E457054");a.IndexParametersObject=new a("D6E229DF-35DA-11D1-9034-00A0C90349BE");a.MediaObjectIndexParametersObject=new a("6B203BAD-3F11-48E4-ACA8-D7613DE2CFA7");a.TimecodeIndexParametersObject=new a("F55E496D-9797-4B5D-8C8B-604DFE9BFB24");a.CompatibilityObject=new a("26F18B5D-4584-47EC-9F5F-0E651F0452C9");a.AdvancedContentEncryptionObject=new a("43058533-6981-49E6-9B74-AD12CB86D58C");a.AudioMedia=new a("F8699E40-5B4D-11CF-A8FD-00805F5C442B");a.VideoMedia=new a("BC19EFC0-5B4D-11CF-A8FD-00805F5C442B");a.CommandMedia=new a("59DACFC0-59E6-11D0-A3AC-00A0C90348F6");a.JFIF_Media=new a("B61BE100-5B4E-11CF-A8FD-00805F5C442B");a.Degradable_JPEG_Media=new a("35907DE0-E415-11CF-A917-00805F5C442B");a.FileTransferMedia=new a("91BD222C-F21C-497A-8B6D-5AA86BFC0185");a.BinaryMedia=new a("3AFB65E2-47EF-40F2-AC2C-70A90D71D343");a.ASF_Index_Placeholder_Object=new a("D9AADE20-7C17-4F9C-BC28-8555DD98E2A2");function J(n){return _[n]}function p(n){return H($(n,"utf-16le"))}const _=[p,U,R,Q,K,N,U];function U(n){return new Uint8Array(n)}function R(n,e=0){return N(n,e)===1}function Q(n,e=0){return b.get(n,e)}function K(n,e=0){return u.get(n,e)}function N(n,e=0){return E.get(n,e)}class L extends V("ASF"){}const X={len:30,get:(n,e)=>({objectId:a.fromBin(n,e),objectSize:Number(u.get(n,e+16)),numberOfHeaderObjects:b.get(n,e+24)})},g={len:24,get:(n,e)=>({objectId:a.fromBin(n,e),objectSize:Number(u.get(n,e+16))})};class w{constructor(e){this.len=Number(e.objectSize)-g.len}postProcessTag(e,t,r,s){if(t==="WM/Picture")e.push({id:t,value:P.fromBuffer(s)});else{const c=J(r);if(!c)throw new L(`unexpected value headerType: ${r}`);e.push({id:t,value:c(s)})}}}class z extends w{get(e,t){return null}}class O extends w{get(e,t){return{fileId:a.fromBin(e,t),fileSize:u.get(e,t+16),creationDate:u.get(e,t+24),dataPacketsCount:u.get(e,t+32),playDuration:u.get(e,t+40),sendDuration:u.get(e,t+48),preroll:u.get(e,t+56),flags:{broadcast:D(e,t+64,24),seekable:D(e,t+64,25)},minimumDataPacketSize:b.get(e,t+68),maximumDataPacketSize:b.get(e,t+72),maximumBitrate:b.get(e,t+76)}}}O.guid=a.FilePropertiesObject;class x extends w{get(e,t){return{streamType:a.decodeMediaType(a.fromBin(e,t)),errorCorrectionType:a.fromBin(e,t+8)}}}x.guid=a.StreamPropertiesObject;class I{constructor(){this.len=22}get(e,t){const r=new DataView(e.buffer,t);return{reserved1:a.fromBin(e,t),reserved2:r.getUint16(16,!0),extensionDataSize:r.getUint16(18,!0)}}}I.guid=a.HeaderExtensionObject;const Y={len:20,get:(n,e)=>({entryCount:new DataView(n.buffer,e).getUint16(16,!0)})};async function v(n){const e=await n.readNumber(E);return(await n.readToken(new h(e*2,"utf-16le"))).replace("\0","")}async function Z(n){const e=await n.readToken(Y),t=[];for(let r=0;r<e.entryCount;++r)t.push(await te(n));return t}async function ee(n){const e=await n.readNumber(E),t=new Uint8Array(e);return await n.readBuffer(t),t}async function te(n){const e=await n.readNumber(E);return{type:{videoCodec:(e&1)===1,audioCodec:(e&2)===2},codecName:await v(n),description:await v(n),information:await ee(n)}}class l extends w{get(e,t){const r=[],s=new DataView(e.buffer,t);let c=10;for(let i=0;i<l.contentDescTags.length;++i){const o=s.getUint16(i*2,!0);if(o>0){const d=l.contentDescTags[i],C=c+o;r.push({id:d,value:p(e.subarray(t+c,t+C))}),c=C}}return r}}l.guid=a.ContentDescriptionObject;l.contentDescTags=["Title","Author","Copyright","Description","Rating"];class y extends w{get(e,t){const r=[],s=new DataView(e.buffer,t),c=s.getUint16(0,!0);let i=2;for(let o=0;o<c;o+=1){const d=s.getUint16(i,!0);i+=2;const C=p(e.subarray(t+i,t+i+d));i+=d;const m=s.getUint16(i,!0);i+=2;const A=s.getUint16(i,!0);i+=2;const j=e.subarray(t+i,t+i+A);i+=A,this.postProcessTag(r,C,m,j)}return r}}y.guid=a.ExtendedContentDescriptionObject;class T extends w{get(e,t){const r=new DataView(e.buffer,t);return{startTime:u.get(e,t),endTime:u.get(e,t+8),dataBitrate:r.getInt32(12,!0),bufferSize:r.getInt32(16,!0),initialBufferFullness:r.getInt32(20,!0),alternateDataBitrate:r.getInt32(24,!0),alternateBufferSize:r.getInt32(28,!0),alternateInitialBufferFullness:r.getInt32(32,!0),maximumObjectSize:r.getInt32(36,!0),flags:{reliableFlag:D(e,t+40,0),seekableFlag:D(e,t+40,1),resendLiveCleanpointsFlag:D(e,t+40,2)},streamNumber:r.getInt16(42,!0),streamLanguageId:r.getInt16(44,!0),averageTimePerFrame:r.getInt32(52,!0),streamNameCount:r.getInt32(54,!0),payloadExtensionSystems:r.getInt32(56,!0),streamNames:[],streamPropertiesObject:null}}}T.guid=a.ExtendedStreamPropertiesObject;class B extends w{get(e,t){const r=[],s=new DataView(e.buffer,t),c=s.getUint16(0,!0);let i=2;for(let o=0;o<c;o+=1){i+=4;const d=s.getUint16(i,!0);i+=2;const C=s.getUint16(i,!0);i+=2;const m=s.getUint32(i,!0);i+=4;const A=p(e.subarray(t+i,t+i+d));i+=d;const j=e.subarray(t+i,t+i+m);i+=m,this.postProcessTag(r,A,C,j)}return r}}B.guid=a.MetadataObject;class k extends B{}k.guid=a.MetadataLibraryObject;class P{static fromBuffer(e){return new P(e.length).get(e,0)}constructor(e){this.len=e}get(e,t){const r=new DataView(e.buffer,t),s=r.getUint8(0),c=r.getInt32(1,!0);let i=5;for(;r.getUint16(i)!==0;)i+=2;const o=new h(i-5,"utf-16le").get(e,5);for(;r.getUint16(i)!==0;)i+=2;const d=new h(i-5,"utf-16le").get(e,5);return{type:W[s],format:o,description:d,size:c,data:e.slice(i+4)}}}const F=q("music-metadata:parser:ASF"),ae="asf";class ne extends G{async parse(){const e=await this.tokenizer.readToken(X);if(!e.objectId.equals(a.HeaderObject))throw new L(`expected asf header; but was not found; got: ${e.objectId.str}`);try{await this.parseObjectHeader(e.numberOfHeaderObjects)}catch(t){F("Error while parsing ASF: %s",t)}}async parseObjectHeader(e){let t;do{const r=await this.tokenizer.readToken(g);switch(F("header GUID=%s",r.objectId.str),r.objectId.str){case O.guid.str:{const s=await this.tokenizer.readToken(new O(r));this.metadata.setFormat("duration",Number(s.playDuration/BigInt(1e3))/1e4-Number(s.preroll)/1e3),this.metadata.setFormat("bitrate",s.maximumBitrate);break}case x.guid.str:{const s=await this.tokenizer.readToken(new x(r));this.metadata.setFormat("container",`ASF/${s.streamType}`);break}case I.guid.str:{const s=await this.tokenizer.readToken(new I);await this.parseExtensionObject(s.extensionDataSize);break}case l.guid.str:t=await this.tokenizer.readToken(new l(r)),await this.addTags(t);break;case y.guid.str:t=await this.tokenizer.readToken(new y(r)),await this.addTags(t);break;case a.CodecListObject.str:{const s=await Z(this.tokenizer);s.forEach(i=>{this.metadata.addStreamInfo({type:i.type.videoCodec?f.video:f.audio,codecName:i.codecName})});const c=s.filter(i=>i.type.audioCodec).map(i=>i.codecName).join("/");this.metadata.setFormat("codec",c);break}case a.StreamBitratePropertiesObject.str:await this.tokenizer.ignore(r.objectSize-g.len);break;case a.PaddingObject.str:F("Padding: %s bytes",r.objectSize-g.len),await this.tokenizer.ignore(r.objectSize-g.len);break;default:this.metadata.addWarning(`Ignore ASF-Object-GUID: ${r.objectId.str}`),F("Ignore ASF-Object-GUID: %s",r.objectId.str),await this.tokenizer.readToken(new z(r))}}while(--e)}async addTags(e){await Promise.all(e.map(({id:t,value:r})=>this.metadata.addTag(ae,t,r)))}async parseExtensionObject(e){do{const t=await this.tokenizer.readToken(g),r=t.objectSize-g.len;switch(t.objectId.str){case T.guid.str:await this.tokenizer.readToken(new T(t));break;case B.guid.str:{const s=await this.tokenizer.readToken(new B(t));await this.addTags(s);break}case k.guid.str:{const s=await this.tokenizer.readToken(new k(t));await this.addTags(s);break}case a.PaddingObject.str:await this.tokenizer.ignore(r);break;case a.CompatibilityObject.str:await this.tokenizer.ignore(r);break;case a.ASF_Index_Placeholder_Object.str:await this.tokenizer.ignore(r);break;default:this.metadata.addWarning(`Ignore ASF-Object-GUID: ${t.objectId.str}`),await this.tokenizer.readToken(new z(t));break}e-=t.objectSize}while(e>0)}}export{ne as AsfParser};
