import{U as x,N as G,D as V,y as Y,k as T,O as v,P as w,e as u,b as U,Q as j,R as z,V as X,A as K,m as Z,d as Q,G as q,K as J,W as R,c as y}from"./main-tDLtfsZw.js";const F={len:16,get:(n,e)=>{const t=x.get(n,e+8),a=x.get(n,e+12);return{startTime:x.get(n,e),endTime:x.get(n,e+4),startOffset:t===4294967295?void 0:t,endOffset:a===4294967295?void 0:a}}};function W(n){switch(n){case 2:return 6;case 3:case 4:return 10;default:throw B(n)}}function _(n){return{status:{tag_alter_preservation:T(n,0,6),file_alter_preservation:T(n,0,5),read_only:T(n,0,4)},format:{grouping_identity:T(n,1,7),compression:T(n,1,3),encryption:T(n,1,2),unsynchronisation:T(n,1,1),data_length_indicator:T(n,1,0)}}}function L(n,e,t){switch(e){case 2:return A(n,e,t);case 3:case 4:return ee(n,e,t);default:throw B(e)}}function A(n,e,t){const a={id:V(n.subarray(0,3),"ascii"),length:Y.get(n,3)};return a.id.match(/^[A-Z0-9]{3}$/)||t.addWarning(`Invalid ID3v2.${e} frame-header-ID: ${a.id}`),a}function ee(n,e,t){const a={id:V(n.subarray(0,4),"ascii"),length:(e===4?G:x).get(n,4),flags:_(n.subarray(8,10))};return a.id.match(/^[A-Z0-9]{4}$/)||t.addWarning(`Invalid ID3v2.${e} frame-header-ID: ${a.id}`),a}function B(n){throw new $(`Unexpected majorVer: ${n}`)}const N=Q("music-metadata:id3v2:frame-parser"),p="latin1",M={encoding:p,bom:!1};function te(n){const e=[];let t,a="";for(const i of n)if(typeof t=="string")if(i==="("&&t==="")a+="(",t=void 0;else if(i===")"){a!==""&&(e.push(a),a="");const r=P(t);r&&e.push(r),t=void 0}else t+=i;else i==="("?t="":a+=i;return a&&(e.length===0&&a.match(/^\d*$/)&&(a=P(a)),a&&e.push(a)),e}function P(n){if(n==="RX")return"Remix";if(n==="CR")return"Cover";if(n.match(/^\d*$/))return q[Number.parseInt(n,10)]}class h{constructor(e,t){this.major=e,this.warningCollector=t}readData(e,t,a){if(e.length===0){this.warningCollector.addWarning(`id3v2.${this.major} header has empty tag type=${t}`);return}const{encoding:i,bom:r}=v.get(e,0),g=e.length;let d=0,c=[];const E=h.getNullTerminatorLength(i);let l;switch(N(`Parsing tag type=${t}, encoding=${i}, bom=${r}`),t!=="TXXX"&&t[0]==="T"?"T*":t){case"T*":case"GRP1":case"IPLS":case"MVIN":case"MVNM":case"PCS":case"PCST":{let s;try{s=h.trimNullPadding(u(e.subarray(1),i))}catch(o){if(o instanceof Error){this.warningCollector.addWarning(`id3v2.${this.major} type=${t} header has invalid string value: ${o.message}`);break}throw o}switch(t){case"TMCL":case"TIPL":case"IPLS":c=h.functionList(this.splitValue(t,s));break;case"TRK":case"TRCK":case"TPOS":case"TIT1":case"TIT2":case"TIT3":c=s;break;case"TCOM":case"TEXT":case"TOLY":case"TOPE":case"TPE1":case"TSRC":c=this.splitValue(t,s);break;case"TCO":case"TCON":c=this.splitValue(t,s).map(o=>te(o)).reduce((o,m)=>o.concat(m),[]);break;case"PCS":case"PCST":c=this.major>=4?this.splitValue(t,s):[s],c=Array.isArray(c)&&c[0]===""?1:0;break;default:c=this.major>=4?this.splitValue(t,s):[s]}break}case"TXXX":{const s=h.readIdentifierAndData(e.subarray(1),i);c={description:s.id,text:this.splitValue(t,u(s.data,i).replace(/\x00+$/,""))};break}case"PIC":case"APIC":if(a){const s={};switch(e=e.subarray(1),this.major){case 2:s.format=u(e.subarray(0,3),"latin1"),e=e.subarray(3);break;case 3:case 4:l=w(e,p),s.format=u(e.subarray(0,l),p),e=e.subarray(l+1);break;default:throw ae(this.major)}s.format=h.fixPictureMimeType(s.format),s.type=K[e[0]],e=e.subarray(1),l=w(e,i),s.description=u(e.subarray(0,l),i),e=e.subarray(l+E),s.data=e,c=s}break;case"CNT":case"PCNT":c=j(e);break;case"SYLT":{const s=X.get(e,0);e=e.subarray(X.len);const o={descriptor:"",language:s.language,contentType:s.contentType,timeStampFormat:s.timeStampFormat,syncText:[]};let m=!1;for(;e.length>0;){const f=h.readNullTerminatedString(e,s.encoding);if(e=e.subarray(f.len),m){const I=x.get(e,0);e=e.subarray(x.len),o.syncText.push({text:f.text,timestamp:I})}else o.descriptor=f.text,m=!0}c=o;break}case"ULT":case"USLT":case"COM":case"COMM":{const s=z.get(e,d);d+=z.len;const o=h.readNullTerminatedString(e.subarray(d),s.encoding);d+=o.len;const m=h.readNullTerminatedString(e.subarray(d),s.encoding);c={language:s.language,descriptor:o.text,text:m.text};break}case"UFID":{const s=h.readIdentifierAndData(e,p);c={owner_identifier:s.id,identifier:s.data};break}case"PRIV":{const s=h.readIdentifierAndData(e,p);c={owner_identifier:s.id,data:s.data};break}case"POPM":{e=e.subarray(d);const s=h.readNullTerminatedString(e,M),o=s.text;if(e=e.subarray(s.len),e.length===0){this.warningCollector.addWarning(`id3v2.${this.major} type=${t} POPM frame missing rating byte`),c={email:o,rating:0,counter:void 0};break}const m=U.get(e,0),f=e.subarray(U.len);c={email:o,rating:m,counter:f.length>0?j(f):void 0};break}case"GEOB":{const s=v.get(e,0);e=e.subarray(1);const o=h.readNullTerminatedString(e,M),m=o.text;e=e.subarray(o.len);const f=h.readNullTerminatedString(e,s),I=f.text;e=e.subarray(f.len);const C=h.readNullTerminatedString(e,s),S=C.text;e=e.subarray(C.len),c={type:m,filename:I,description:S,data:e};break}case"WCOM":case"WCOP":case"WOAF":case"WOAR":case"WOAS":case"WORS":case"WPAY":case"WPUB":c=h.readNullTerminatedString(e,M).text;break;case"WXXX":{const s=v.get(e,0);e=e.subarray(1);const o=h.readNullTerminatedString(e,s),m=o.text;e=e.subarray(o.len),c={description:m,url:h.trimNullPadding(u(e,p))};break}case"WFD":case"WFED":{const s=v.get(e,0);e=e.subarray(1),c=h.readNullTerminatedString(e,s).text;break}case"MCDI":{c=e.subarray(0,g);break}case"CHAP":{N("Reading CHAP"),l=w(e,p);const s={label:u(e.subarray(0,l),p),info:F.get(e,l+1),frames:new Map};for(d+=l+1+F.len;d<g;){const o=L(e.subarray(d),this.major,this.warningCollector),m=W(this.major);d+=m;const f=this.readData(e.subarray(d,d+o.length),o.id,a);d+=o.length,s.frames.set(o.id,f)}c=s;break}case"CTOC":{N("Reading CTOC");const s=w(e,p),o=u(e.subarray(0,s),p);d=s+1;const m=e[d++],f=(m&2)!==0,I=(m&1)!==0,C=e[d++],S=[];for(let b=0;b<C&&d<g;b++){const D=w(e.subarray(d),p),O=u(e.subarray(d,d+D),p);S.push(O),d+=D+1}const H={label:o,flags:{topLevel:f,ordered:I},childElementIds:S,frames:new Map};for(;d<g;){const b=L(e.subarray(d),this.major,this.warningCollector),D=W(this.major);d+=D;const O=this.readData(e.subarray(d,d+b.length),b.id,a);d+=b.length,H.frames.set(b.id,O)}c=H;break}default:N(`Warning: unsupported id3v2-tag-type: ${t}`);break}return c}static readNullTerminatedString(e,t){const a=t.bom?2:0,i=e.length,r=e.subarray(a),g=w(r,t.encoding);if(g>=r.length)return{text:u(r,t.encoding),len:i};const d=r.subarray(0,g);return{text:u(d,t.encoding),len:a+g+h.getNullTerminatorLength(t.encoding)}}static fixPictureMimeType(e){switch(e=e.toLocaleLowerCase(),e){case"jpg":return"image/jpeg";case"png":return"image/png"}return e}static functionList(e){const t={};for(let a=0;a+1<e.length;a+=2){const i=e[a+1].split(",");t[e[a]]=t[e[a]]?t[e[a]].concat(i):i}return t}splitValue(e,t){let a;return this.major<4?(a=t.split(/\x00/g),a.length>1?this.warningCollector.addWarning(`ID3v2.${this.major} ${e} uses non standard null-separator.`):a=t.split(/\//g)):a=t.split(/\x00/g),h.trimArray(a)}static trimArray(e){return e.map(t=>h.trimNullPadding(t).trim())}static trimNullPadding(e){let t=e.length;for(;t>0&&e.charCodeAt(t-1)===0;)t--;return t===e.length?e:e.slice(0,t)}static readIdentifierAndData(e,t){const a=h.readNullTerminatedString(e,{encoding:t,bom:!1});return{id:a.text,data:e.subarray(a.len)}}static getNullTerminatorLength(e){return e.startsWith("utf-16")?2:1}}class $ extends Z("id3v2"){}function ae(n){throw new $(`Unexpected majorVer: ${n}`)}class k{constructor(){this.tokenizer=void 0,this.id3Header=void 0,this.metadata=void 0,this.headerType=void 0,this.options=void 0}static removeUnsyncBytes(e){let t=0,a=0;for(;t<e.length-1;)t!==a&&(e[a]=e[t]),t+=e[t]===255&&e[t+1]===0?2:1,a++;return t<e.length&&(e[a++]=e[t]),e.subarray(0,a)}static readFrameData(e,t,a,i,r){var d,c;const g=new h(a,r);switch(a){case 2:return g.readData(e,t.id,i);case 3:case 4:return(d=t.flags)!=null&&d.format.unsynchronisation&&(e=k.removeUnsyncBytes(e)),(c=t.flags)!=null&&c.format.data_length_indicator&&(e=e.subarray(4,e.length)),g.readData(e,t.id,i);default:throw se(a)}}static makeDescriptionTagName(e,t){return e+(t?`:${t}`:"")}async parse(e,t,a){this.tokenizer=t,this.metadata=e,this.options=a;const i=await this.tokenizer.readToken(J);if(i.fileIdentifier!=="ID3")throw new $("expected ID3-header file-identifier 'ID3' was not found");this.id3Header=i,this.headerType=`ID3v2.${i.version.major}`,await(i.flags.isExtendedHeader?this.parseExtendedHeader():this.parseId3Data(i.size));const r=k.mapId3v2Chapters(this.metadata.native[this.headerType],this.metadata.format.sampleRate);this.metadata.setFormat("chapters",r)}async parseExtendedHeader(){const e=await this.tokenizer.readToken(R),t=e.size-R.len;return t>0?this.parseExtendedHeaderData(t,e.size):this.parseId3Data(this.id3Header.size-e.size)}async parseExtendedHeaderData(e,t){return await this.tokenizer.ignore(e),this.parseId3Data(this.id3Header.size-t)}async parseId3Data(e){const t=await this.tokenizer.readToken(new y(e));for(const a of this.parseMetadata(t))switch(a.id){case"TXXX":a.value&&await this.handleTag(a,a.value.text,()=>a.value.description);break;default:await(Array.isArray(a.value)?Promise.all(a.value.map(i=>this.addTag(a.id,i))):this.addTag(a.id,a.value))}}async handleTag(e,t,a,i=r=>r){await Promise.all(t.map(r=>this.addTag(k.makeDescriptionTagName(e.id,a(r)),i(r))))}async addTag(e,t){await this.metadata.addTag(this.headerType,e,t)}parseMetadata(e){let t=0;const a=[];for(;t!==e.length;){const i=W(this.id3Header.version.major);if(t+i>e.length){this.metadata.addWarning("Illegal ID3v2 tag length");break}const r=e.subarray(t,t+i);t+=i;const g=L(r,this.id3Header.version.major,this.metadata),d=e.subarray(t,t+g.length);t+=g.length;const c=k.readFrameData(d,g,this.id3Header.version.major,!this.options.skipCovers,this.metadata);c&&a.push({id:g.id,value:c})}return a}static mapId3v2Chapters(e,t){const a=e.filter(l=>l.id==="CHAP");if(!(a!=null&&a.length))return;const i=e.filter(l=>l.id==="CTOC"),r=i==null?void 0:i.find(l=>{var s;return(s=l.value.flags)==null?void 0:s.topLevel}),g=new Map;for(const l of a)g.set(l.value.label,l.value);const d=r==null?void 0:r.value.childElementIds,c=[],E=d??[...g.keys()];for(const l of E){const s=g.get(l);if(!s)continue;const o=s.frames,m=o.get("TIT2");m&&c.push({id:l,title:m,url:o.get("WXXX"),start:s.info.startTime/1e3,end:s.info.endTime/1e3,image:o.get("APIC")})}return d||c.sort((l,s)=>l.start-s.start),c.length?c:void 0}}function se(n){throw new $(`Unexpected majorVer: ${n}`)}export{k as I};
